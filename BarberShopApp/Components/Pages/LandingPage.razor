@page "/"
@layout Layout.LandingLayout
@using BarberShopApp.Core.Models
@using BarberShopApp.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory

@rendermode InteractiveServer
<PageTitle>Barbearia - Agende seu Horário</PageTitle>

<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-overlay"></div>
    <div class="container">
        <div class="row align-items-center min-vh-100">
            <div class="col-lg-6">
                <div class="hero-content">
                    <h1 class="hero-title">
                        Barbearia <span class="text-primary">Profissional</span>
                    </h1>
                    <p class="hero-subtitle">
                        Transforme seu visual com nossos especialistas. 
                        Agende seu horário de forma rápida e descomplicada.
                    </p>
                    <div class="hero-stats">
                        <div class="stat-item">
                            <div class="stat-number">@Servicos.Count</div>
                            <div class="stat-label">Serviços</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">@Profissionais.Count</div>
                            <div class="stat-label">Profissionais</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">100%</div>
                            <div class="stat-label">Satisfação</div>
                        </div>
                    </div>
                    <div class="hero-buttons">
                        <button type="button" class="btn btn-primary btn-lg me-3" @onclick="ScrollToAgendamento">
                            <i class="fas fa-calendar-plus me-2"></i>Agendar Agora
                        </button>
                        <button type="button" class="btn btn-outline-light btn-lg" @onclick="ScrollToServicos">
                            <i class="fas fa-scissors me-2"></i>Ver Serviços
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="hero-image">
                    <img src="https://images.unsplash.com/photo-1503951914875-452162b0f3f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80" 
                         alt="Barbearia" class="img-fluid rounded-4 shadow-2xl">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Serviços Section -->
<div id="servicos" class="services-section">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center mb-5">
                <h2 class="section-title">Nossos Serviços</h2>
                <p class="section-subtitle">Oferecemos uma ampla variedade de serviços para cuidar do seu visual</p>
            </div>
        </div>
        <div class="row">
            @foreach (var servico in Servicos)
            {
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="service-card">
                                                 <div class="service-image">
                             <img src="@servico.ImgUrl" alt="@servico.Nome">
                         </div>
                        <div class="service-content">
                            <h5 class="service-title">@servico.Nome</h5>
                            <p class="service-description">@servico.Descricao</p>
                            <div class="service-meta">
                                <span class="service-duration">@servico.DuracaoEmMinutos min</span>
                                <span class="service-price">R$ @servico.Preco.ToString("F2")</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Agendamento Section -->
<div id="agendamento" class="booking-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="booking-card">
                    <div class="booking-header">
                        <h3 class="booking-title">
                            <i class="fas fa-calendar-plus me-3"></i>
                            Agendar Horário
                        </h3>
                        <p class="booking-subtitle">Complete os passos abaixo para agendar seu horário</p>
                    </div>
                    <div class="booking-body">
                        <!-- Progress Bar -->
                        <div class="progress-container">
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: @((CurrentStep * 100 / TotalSteps) + "%")"></div>
                            </div>
                            <div class="progress-text">Passo @CurrentStep de @TotalSteps</div>
                        </div>

                        <!-- Step Indicators -->
                        <div class="step-indicators">
                            <div class="step-item @(CurrentStep >= 1 ? "active" : "")">
                                <div class="step-circle">1</div>
                                <div class="step-label">Serviços</div>
                            </div>
                            <div class="step-line @(CurrentStep >= 2 ? "active" : "")"></div>
                            <div class="step-item @(CurrentStep >= 2 ? "active" : "")">
                                <div class="step-circle">2</div>
                                <div class="step-label">Profissional</div>
                            </div>
                            <div class="step-line @(CurrentStep >= 3 ? "active" : "")"></div>
                            <div class="step-item @(CurrentStep >= 3 ? "active" : "")">
                                <div class="step-circle">3</div>
                                <div class="step-label">Horário</div>
                            </div>
                            <div class="step-line @(CurrentStep >= 4 ? "active" : "")"></div>
                            <div class="step-item @(CurrentStep >= 4 ? "active" : "")">
                                <div class="step-circle">4</div>
                                <div class="step-label">Dados</div>
                            </div>
                        </div>

                        <!-- Step Content -->
                        <div class="step-content">
                            @if (CurrentStep == 1)
                            {
                                <!-- Step 1: Seleção de Serviços -->
                                <div class="step-panel">
                                    <h4 class="step-title">
                                        <i class="fas fa-scissors me-2"></i>
                                        Escolha seus Serviços
                                    </h4>
                                    <p class="step-description">Selecione os serviços que deseja agendar</p>
                                    
                                    <div class="services-grid">
                                        @foreach (var servico in Servicos)
                                        {
                                            <div class="service-select-card @(ServicosSelecionados.Any(s => s.Id == servico.Id) ? "selected" : "")"
                                                 @onclick="@(() => ToggleServico(servico))">
                                                                                                 <div class="service-select-image">
                                                     <img src="@servico.ImgUrl" alt="@servico.Nome">
                                                 </div>
                                                <div class="service-select-content">
                                                    <h5 class="service-select-title">@servico.Nome</h5>
                                                    <p class="service-select-description">@servico.Descricao</p>
                                                    <div class="service-select-meta">
                                                        <span class="service-select-duration">@servico.DuracaoEmMinutos min</span>
                                                        <span class="service-select-price">R$ @servico.Preco.ToString("F2")</span>
                                                    </div>
                                                </div>
                                                <div class="service-select-check">
                                                    <i class="fas fa-check"></i>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            else if (CurrentStep == 2)
                            {
                                <!-- Step 2: Seleção de Profissional -->
                                <div class="step-panel">
                                    <h4 class="step-title">
                                        <i class="fas fa-user-tie me-2"></i>
                                        Escolha o Profissional
                                    </h4>
                                    <p class="step-description">Selecione o profissional que irá atendê-lo</p>
                                    
                                    <!-- Renderização direta dos profissionais -->
                                    @if (ServicosSelecionados.Any())
                                    {
                                        var profissionaisFiltrados = Profissionais
                                            .Where(p => p.Especialidades != null && 
                                                       ServicosSelecionados.All(s => p.Especialidades.Any(e => e.Id == s.Id)))
                                            .ToList();
                                        
                                        <div class="professionals-grid">
                                            @foreach (var profissional in profissionaisFiltrados)
                                            {
                                                <div class="professional-card @(ProfissionalSelecionado?.Id == profissional.Id ? "selected" : "")"
                                                     @onclick="@(() => SelecionarProfissional(profissional))">
                                                                                                         <div class="professional-image">
                                                         <img src="@profissional.ImgUrl" alt="@profissional.Nome">
                                                     </div>
                                                    <div class="professional-content">
                                                        <h5 class="professional-name">@profissional.Nome</h5>
                                                        <div class="professional-info">
                                                            <div class="info-item">
                                                                <i class="fas fa-envelope"></i>
                                                                <span>@profissional.Email</span>
                                                            </div>
                                                            <div class="info-item">
                                                                <i class="fas fa-phone"></i>
                                                                <span>@profissional.Telefone</span>
                                                            </div>
                                                        </div>
                                                                                                                 @if (profissional.Especialidades != null && profissional.Especialidades.Any())
                                                         {
                                                             <div class="professional-specialties">
                                                                 <strong>Especialidades:</strong>
                                                                 <span>@string.Join(", ", profissional.Especialidades.Select(e => e.Nome))</span>
                                                             </div>
                                                         }
                                                         <div class="professional-smoking">
                                                             <i class="fas @(profissional.Fumante ? "fa-smoking" : "fa-smoking-ban")"></i>
                                                             <span>@(profissional.Fumante ? "Fumante" : "Não fumante")</span>
                                                         </div>
                                                    </div>
                                                    <div class="professional-check">
                                                        <i class="fas fa-check"></i>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Selecione pelo menos um serviço para ver os profissionais disponíveis.
                                        </div>
                                    }
                                </div>
                            }
                            else if (CurrentStep == 3)
                            {
                                <!-- Step 3: Seleção de Data e Horário -->
                                <div class="step-panel">
                                    <h4 class="step-title">
                                        <i class="fas fa-clock me-2"></i>
                                        Escolha Data e Horário
                                    </h4>
                                    <p class="step-description">Selecione a data e horário de sua preferência</p>
                                    
                                    <div class="date-time-selector">
                                        <div class="date-selector">
                                            <label for="dataSelect" class="form-label">Data:</label>
                                            <input type="date" id="dataSelect" class="form-control" 
                                                   @onchange="OnDataChanged" 
                                                   value="@DataSelecionada?.ToString("yyyy-MM-dd")" 
                                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                        </div>
                                        
                                        <div class="time-selector">
                                            <label class="form-label">Horários Disponíveis:</label>
                                            @if (HorariosDisponiveis != null && HorariosDisponiveis.Any())
                                            {
                                                <div class="time-grid">
                                                    @foreach (var horario in HorariosDisponiveis)
                                                    {
                                                        <button type="button"
                                                                class="time-slot @(HorarioSelecionado.HasValue && horario.Equals(HorarioSelecionado.Value) ? "selected" : "")"
                                                                @onclick="@(() => SelecionarHorario(horario))">
                                                            @horario.ToString("HH:mm")
                                                        </button>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    Não há horários disponíveis para a data selecionada.
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                            else if (CurrentStep == 4)
                            {
                                <!-- Step 4: Dados do Cliente -->
                                <div class="step-panel">
                                    <h4 class="step-title">
                                        <i class="fas fa-user me-2"></i>
                                        Dados do Cliente
                                    </h4>
                                    <p class="step-description">Preencha seus dados para finalizar o agendamento</p>
                                    
                                    <div class="client-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="nomeCliente" class="form-label">Nome Completo *</label>
                                                <input type="text" id="nomeCliente" class="form-control" 
                                                       @bind="Agendamento.NomeDoCliente" placeholder="Digite seu nome completo">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="telefoneCliente" class="form-label">Telefone *</label>
                                                <input type="text" id="telefoneCliente" class="form-control" 
                                                       @bind="Agendamento.NumeroDoCliente" placeholder="(99) 99999-9999" maxlength="15">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <label for="observacoes" class="form-label">Observações (opcional)</label>
                                                <textarea id="observacoes" class="form-control" rows="3" 
                                                          @bind="Agendamento.Observacoes" placeholder="Alguma observação especial?"></textarea>
                                            </div>
                                        </div>

                                        <!-- Resumo do Agendamento -->
                                        @if (HorarioSelecionado.HasValue && ProfissionalSelecionado != null && ServicosSelecionados.Any())
                                        {
                                            <div class="booking-summary">
                                                <h5 class="summary-title">
                                                    <i class="fas fa-clipboard-list me-2"></i>
                                                    Resumo do Agendamento
                                                </h5>
                                                <div class="summary-content">
                                                    <div class="summary-item">
                                                        <span class="summary-label">Data/Hora:</span>
                                                        <span class="summary-value">@HorarioSelecionado.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                                    </div>
                                                    <div class="summary-item">
                                                        <span class="summary-label">Profissional:</span>
                                                        <span class="summary-value">@ProfissionalSelecionado.Nome</span>
                                                    </div>
                                                    <div class="summary-item">
                                                        <span class="summary-label">Serviços:</span>
                                                        <span class="summary-value">@string.Join(", ", ServicosSelecionados.Select(s => s.Nome))</span>
                                                    </div>
                                                    <div class="summary-item">
                                                        <span class="summary-label">Duração:</span>
                                                        <span class="summary-value">@ServicosSelecionados.Sum(s => s.DuracaoEmMinutos) minutos</span>
                                                    </div>
                                                    <div class="summary-item total">
                                                        <span class="summary-label">Valor Total:</span>
                                                        <span class="summary-value">R$ @ServicosSelecionados.Sum(s => s.Preco).ToString("F2")</span>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="step-navigation">
                            @if (CurrentStep > 1)
                            {
                                <button type="button" class="btn btn-outline-secondary" @onclick="PreviousStep">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Voltar
                                </button>
                            }
                            
                            @if (CurrentStep < TotalSteps)
                            {
                                <button type="button" class="btn btn-primary" @onclick="NextStep" disabled="@(!CanProceedToNextStep)">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Carregando...</span>
                                    }
                                    else
                                    {
                                        <span>Próximo</span>
                                        <i class="fas fa-arrow-right ms-2"></i>
                                    }
                                </button>
                            }
                            
                            @if (CurrentStep == TotalSteps && CanProceedToNextStep)
                            {
                                <button type="button" class="btn btn-success btn-lg" @onclick="AddAgendamento" disabled="@isLoading">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Finalizando...</span>
                                    }
                                    else
                                    {
                                        <i class="fas fa-check me-2"></i>
                                        <span>Confirmar Agendamento</span>
                                    }
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h5><i class="fas fa-scissors me-2"></i>Barbearia Profissional</h5>
                <p>Transforme seu visual com nossos especialistas. Qualidade e profissionalismo em cada corte.</p>
                <div class="social-links">
                    <a href="#" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            
            <div class="footer-section">
                <h5><i class="fas fa-map-marker-alt me-2"></i>Localização</h5>
                <p><i class="fas fa-map-marker-alt me-2"></i>Rua das Barbearias, 123</p>
                <p><i class="fas fa-phone me-2"></i>(11) 99999-9999</p>
                <p><i class="fas fa-envelope me-2"></i>contato@barbearia.com</p>
            </div>
            
            <div class="footer-section">
                <h5><i class="fas fa-clock me-2"></i>Horário de Funcionamento</h5>
                <p><strong>Segunda a Sexta:</strong> 08:00 - 18:00</p>
                <p><strong>Sábado:</strong> 08:00 - 17:00</p>
                <p><strong>Domingo:</strong> Fechado</p>
            </div>
            
            <div class="footer-section">
                <h5><i class="fas fa-tools me-2"></i>Serviços</h5>
                <p><a href="#servicos">Corte Masculino</a></p>
                <p><a href="#servicos">Barba</a></p>
                <p><a href="#servicos">Corte + Barba</a></p>
                <p><a href="#servicos">Hidratação</a></p>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy;@DateTime.Now.Year.ToString() Barbearia Profissional. Todos os direitos reservados.</p>
            <p><a href="/admin" class="text-light">Área Administrativa</a></p>
        </div>
    </div>
</footer>

<!-- Feedback Message -->
@if (!string.IsNullOrEmpty(mensagemFeedback))
{
    <div class="feedback-toast @tipoMensagem">
        <div class="feedback-content">
            <i class="fas fa-@(tipoMensagem == "success" ? "check-circle" : tipoMensagem == "error" ? "exclamation-circle" : "info-circle") me-2"></i>
            <span>@mensagemFeedback</span>
        </div>
    </div>
} 